<!DOCTYPE html>

<html lang="en">
  <head>
    <link href="/css/video.scss" rel="stylesheet"/>
    <script src="/lib/jquery-1.9.1.min.js"></script>
    <script src="/lib/jwplayer/jwplayer.js"></script>
    <!--script type="text/javascript" src="//use.typekit.net/qgw0qkt.js"></script-->
    <!--script type="text/javascript">try{Typekit.load();}catch(e){}</script--> 
    <script>
        $(function() {
            var move = false;
            $("#dragger").mousedown(function(e) {
                move = true;
            })
            
            $(document).mouseup(function(e) {
                move = false;
            });

            var reverseResize = function(desired, angle, z) {
                var a = angle / 360.0 * Math.PI;
                var ret = (z * desired)/(z * Math.cos(a) - desired * Math.sin(a));
                return ret;
            }
           
            var resizeVideos = function(pageX) {
                var ratio = pageX/$("body").width();
                if (ratio < .5)
                    return;
               
                if ($("body").width() - pageX < 200)
                    return;

                oldRatio = ratio;

                $('#left').css('width', pageX);
                $('#right').css('left', pageX + 1);
                $('#dragger').css('left', pageX + 1);
                
                // var degreeLeft = ratio >= .5 ? 2 : 2 + 20 * (.5 - ratio);
                // var degreeRight = ratio <= .5 ? -2 : -2 + (.5 - ratio) * 20;
                var degreeRight = ratio <= .6 ? 0 : (.6 - ratio) * 45;
                // var dlStr = "rotateY(" + degreeLeft + "deg)";
                var drStr = "rotateY(" + degreeRight + "deg)";

                /*
                $('#main-video-wrapper > video').css({
                    "-webkit-transform": dlStr,
                    "-moz-transform": dlStr,
                    "-ms-transform": dlStr,
                    "-o-transform": dlStr,
                    "transform": dlStr,
                });
                */

                $('#ancilliary-videos > .video-canvas').css({
                    "-webkit-transform": drStr,
                    "-moz-transform": drStr,
                    "-ms-transform": drStr,
                    "-o-transform": drStr,
                    "transform": drStr,
                });

                // var mvWidth = reverseResize($('#main-video-wrapper').width(), degreeLeft, 200);
                var mvWidth = $('#main-video-wrapper').width();
                var mvHeight = mvWidth * 9.0/16.0;
                var ovWidth = reverseResize($('#ancilliary-videos').width(), -degreeRight, 200);
                var ovHeight = ovWidth * 9.0/16.0;
                $("#main-video-wrapper > .video-canvas").css({
                    width: mvWidth,
                    height: mvHeight
                });
                $("#ancilliary-videos > .video-canvas").css({
                    width: ovWidth,
                    height: ovHeight
                });
                $('#main-video-wrapper').css('margin-top', -$('#main-video-wrapper').height()/2);
                $('#ancilliary-videos').css('margin-top', -$('#ancilliary-videos').height()/2);
            }
 
            var currPageX = .65 * $("body").width();
            var oldRatio = .65;
            $(document).mousemove(function(e) {
                if (move) {
                    currPageX = e.pageX;
                    resizeVideos(e.pageX);
                }
            });
                    
            $('#ancilliary-videos').on('click', '.video-canvas', function() {
                $('#main-video-wrapper .video-canvas').insertAfter($(this));
                $(this).appendTo("#main-video-wrapper");
                resizeVideos(currPageX);
                $('video').each(function(i, e) {
                    e.play();
                });
            });
           
            $(window).resize(function() {
                currPageX = oldRatio * $("body").width();
                if ($("body").width() - currPageX < 200)
                    currPageX = $("body").width() - 200;
                resizeVideos(currPageX);
            });

            $(window).trigger('resize');

            var video = $("#source-video")[0];
            function update(video) {
                $('.video-canvas').each(function(i, canvas) {
                    var context = canvas.getContext('2d');
                    var x = ($(canvas).attr('data-segment') - 1) * 640;
                    context.drawImage(video, x, 0, 640, 360, 0, 0, 640, 360);
                });
                setTimeout(function() { update(video) }, 30);
            }
            update(video);
        });
    </script>
    <title>Hello World!</title>
  </head>
  <body>
    <video id="source-video" autoplay src="http://d2o9nyf4hwsci4.cloudfront.net/.test/3vids-360p.mp4">
    </video>
    <div id="left">
      <div id="main-video-wrapper">
        <canvas class="video-canvas" width="640" height="360" data-segment="1"></canvas>
      </div>
    </div>
    <div id="dragger"> 
    </div>
    <div id="right">
      <div id="ancilliary-videos">
        <canvas class="video-canvas" width="640" height="360" data-segment="2"></canvas>
        <canvas class="video-canvas" width="640" height="360" data-segment="3"></canvas>
      </div>
    </div>
    <div id="control-bar">
      <div id="left-controls">
        <div id="play-pause-control"></div><div id="skip-control">
        </div>
      </div>
      <div id="time">
        <div id="timecode">00:55</div>
        <div id="progress"></div>
        <div id="timeline"></div>
        <div id="timelength">13:37</div>
      </div>
      <div id="right-controls">
        <div id="download-control"></div><div id="captions-control">
        </div><div id="quality-control">
          HD
        </div><div id="fullscreen-control">
        </div>
      </div>
    </div>
  </body>
</html>
